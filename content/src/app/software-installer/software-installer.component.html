<div class="software-installer-container">
    <h2>Software Installer</h2>
    @if (!hasChosenLocation) {
      <div class="step-indicator">Step 1 of 4</div>
      <p class="step-description">You do not have the necessary software installed for ModusToolbox. This view will help get the correct software installed.</p>
      <div class="tile-row">
        <div class="install-tile no-account" (click)="onNoAccountClick()" [class.disabled]="loadingTools" [attr.aria-disabled]="loadingTools ? true : null" [style.pointer-events]="loadingTools ? 'none' : 'auto'">
          <div class="tile-content">
            <span class="tile-icon">&#9888;</span>
            <h3>No Infineon Account?</h3>
            <p>Click here if you do not have an Infineon account.  Return to this page after your account is created.</p>
          </div>
        </div>
        <div class="install-tile has-account" (click)="onHasAccountClick()">
          <div class="tile-content">
            <span class="tile-icon">&#128274;</span>
            <h3>Have an Infineon Account?</h3>
            <p>Click here to log in and manage your software. A browser will open for authentication.</p>
          </div>
        </div>
      </div>
      @if (loadingTools) {
        <div class="gather-tools-message">
          <h3>Gather information on required tools ...</h3>
          <div class="spinner"></div>
        </div>
      }
    }
    @else {
      <div class="step-indicator">Step {{ step + 2 }} of 4</div>
      @switch (step) {
      @case (0) {
        <div class="install-choice-container">
          <p class="intro-text">Pick a method for installing ModusToolbox and related tools</p>
          <div class="cards-wrapper">
            <div class="choice-card" [class.selected]="installChoice==='home'" [class.disabled]="homeError" (click)="selectInstallChoice('home')">
              <div class="card-content">
                <div class="card-header">
                  <mat-icon>home</mat-icon>
                  <h3>Install Under Home Directory</h3>
                </div>
                <p class="card-description">Install ModusToolbox and related tools under your home directory on this machine.</p>
              </div>
              @if (homeWarning && !homeError) { <div class="warning-text">{{ homeWarning }}</div> }
              @if (homeError) { <div class="error-text">{{ homeError }}</div> }
            </div>
            <div class="choice-card" [class.selected]="installChoice==='custom'" [class.disabled]="customError" (click)="selectInstallChoice('custom')">
              <div class="card-content">
                <div class="card-header">
                  <mat-icon>folder_open</mat-icon>
                  <h3>Install In Custom Directory</h3>
                </div>
                <p class="card-description">Install ModusToolbox and related tools in a directory of your choosing. This directory should not contain any spaces.</p>
                <div class="custom-path-row" (click)="$event.stopPropagation()">
                  <mat-form-field appearance="outline" class="path-field">
                    <mat-label>Custom Install Path</mat-label>
                    <input matInput [disabled]="!!customError" [ngModel]="customPath" (ngModelChange)="onCustomPathInput($event)" placeholder="/path/to/modustoolbox" />
                  </mat-form-field>
                  <button mat-raised-button color="primary" (click)="browseForCustom()" [disabled]="!!customError"><mat-icon>folder</mat-icon>&nbsp;Browse</button>
                </div>
              </div>
              @if (customWarning && !customError) { <div class="warning-text">{{ customWarning }}</div> }
              @if (customError) { <div class="error-text">{{ customError }}</div> }
            </div>
          </div>
          <div class="actions-row">
            <button mat-raised-button color="primary" (click)="locationNext()" [disabled]="disableNext || !installChoice || (installChoice==='custom' && !customPath)">Next</button>
          </div>
        </div>
      }
      @case (1) {
        <div class="confirm-tools">
          <h3>Confirm Tools to Download & Install</h3>
          <div class="tool-section">
            <h4>Required Software</h4>
            <ul class="tool-list">
              @for (tool of neededTools; track tool.featureId) {
                @if (tool.required && (!downloading || activeInstallSet.has(tool.featureId))) {
                  <li>
                    <div class="tool-info">
                      <span class="tool-name">{{ tool.name }}
                      @if (tool.current) {
                         (v{{ tool.current }})
                      }
                      @else {
                        (none)
                      }
                      </span>
                      @if (tool.installed) {
                        <span class="tool-status installed">Already installed</span>
                        @if (tool.upgradable) {
                          <label>
                            <input type="checkbox" [(ngModel)]="upgradeSelections[tool.featureId]"> Upgrade v{{ tool.version || 'latest' }}
                          </label>
                        }
                      } @else {
                        <span class="tool-status will-install">Install v{{ tool.version }}</span>
                      }
                    </div>
                    @if (progress[tool.featureId].message) {
                      <div class="progress-message">{{ progress[tool.featureId].message }}</div>
                      <div class="progress-bar">
                        <div class="progress-fill" [style.width.%]="progress[tool.featureId].percent"></div>
                      </div>
                    }
                  </li>
                }
              }
            </ul>
          </div>
          <button class="next-btn" (click)="onConfirmTools()" [disabled]="disableNext || downloading">
            @if (downloading) {
              Installing...
            } @else {
              Install Now
            }
          </button>
          @if (downloading) {
            <div class="downloading-message">
              <h3>Downloading and Installing Requested Software ...</h3>
              <div class="spinner"></div>
            </div>
          }
        </div>
      }
      @case (2) {
        <div class="install-complete">
          <h3>Installation Complete!</h3>
          <p>All selected tools have been downloaded and installed.</p>
          <button class="reinit-btn" (click)="onReinit()">Reinitialize Extension</button>
        </div>
      }
    }
    }
</div>