<div class="software-installer-container">
    <h2>Software Installer</h2>
    <div class="step-indicator">Step {{ step + 1 }} of 3</div>
    @switch (step) {
      @case (0) {
        <div class="tile-row">
          <div class="install-tile no-account" (click)="onNoAccountClick()" [class.disabled]="loadingTools" [attr.aria-disabled]="loadingTools ? true : null" [style.pointer-events]="loadingTools ? 'none' : 'auto'">
            <div class="tile-content">
              <span class="tile-icon">&#9888;</span>
              <h3>No Infineon Account?</h3>
              <p>Click here if you do not have an Infineon account.  Return to this page after your account is created.</p>
            </div>
          </div>
          <div class="install-tile has-account" (click)="onHasAccountClick()">
            <div class="tile-content">
              <span class="tile-icon">&#128274;</span>
              <h3>Have an Infineon Account?</h3>
              <p>Click here to log in and manage your software. A browser will open for authentication.</p>
            </div>
          </div>
        </div>
        @if (loadingTools) {
          <div class="gather-tools-message">
            <h3>Gather information on required tools ...</h3>
            <div class="spinner"></div>
          </div>
        }
      }
      @case (1) {
        <div class="confirm-tools">
          <h3>Confirm Tools to Download & Install</h3>
          <div class="tool-section">
            <h4>Required Software</h4>
            <ul class="tool-list">
              @for (tool of neededTools; track tool.featureId) {
                @if (tool.required) {
                  <li>
                    <div class="tool-info">
                      <span class="tool-name">{{ tool.name }}
                      @if (tool.current) {
                         (v{{ tool.current }})
                      }
                      @else {
                        (none)
                      }
                      </span>
                      @if (tool.installed) {
                        <span class="tool-status installed">Already installed</span>
                        @if (tool.upgradable) {
                          <label>
                            <input type="checkbox" [(ngModel)]="upgradeSelections[tool.featureId]"> Upgrade v{{ tool.version || 'latest' }}
                          </label>
                        }
                      } @else {
                        <span class="tool-status will-install">Install v{{ tool.version }}</span>
                      }
                    </div>
                    @if (progress[tool.featureId]?.message) {
                      <div class="progress-message">{{ progress[tool.featureId].message }}</div>
                      <div class="progress-bar">
                        <div class="progress-fill" [style.width.%]="progress[tool.featureId].percent"></div>
                      </div>
                    }
                  </li>
                }
              }
            </ul>
          </div>
          <div class="tool-section">
            <h4>Optional Software</h4>
            <ul class="tool-list">
              @for (tool of neededTools; track tool.featureId) {
                @if (!tool.required) {
                  <li>
                    <div class="tool-info">
                      <span class="tool-name">{{ tool.name }} (v{{ tool.version }})</span>
                      @if (tool.installed) {
                        <span class="tool-status installed">Already installed</span>
                      } @else {
                        <label><input type="checkbox" [(ngModel)]="installSelections[tool.featureId]"> Install</label>
                      }
                    </div>
                    @if (progress[tool.featureId]?.message) {
                      <div class="progress-message">{{ progress[tool.featureId].message }}</div>
                      <div class="progress-bar">
                        <div class="progress-fill" [style.width.%]="progress[tool.featureId].percent"></div>
                      </div>
                    }
                  </li>
                }
              }
            </ul>
          </div>
          <button class="next-btn" (click)="onConfirmTools()">Install Now</button>
          @if (downloading) {
            <div class="downloading-message">
              <h3>Downloading and Installing Requested Software ...</h3>
              <div class="spinner"></div>
            </div>
          }
        </div>
      }
      @case (2) {
        <div class="install-complete">
          <h3>Installation Complete!</h3>
          <p>All selected tools have been downloaded and installed.</p>
          <button class="reinit-btn" (click)="onReinit()">Reinitialize Extension</button>
        </div>
      }
    }
</div>