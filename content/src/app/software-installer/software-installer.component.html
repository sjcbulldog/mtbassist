<div class="software-installer-container">
    <h2>Software Installer</h2>
    @if (!hasChosenLocation) {
      <div class="step-indicator">Step 1 of 4</div>
      <p class="step-description">You do not have the necessary software installed for ModusToolbox. This view will help get the correct software installed.</p>
      <div class="tile-row">
        <div class="install-tile no-account" (click)="onNoAccountClick()" [class.disabled]="loadingTools" [attr.aria-disabled]="loadingTools ? true : null" [style.pointer-events]="loadingTools ? 'none' : 'auto'">
          <div class="tile-content">
            <span class="tile-icon">&#9888;</span>
            <h3>No Infineon Account?</h3>
            <p>Click here if you do not have an Infineon account. The Infineon site will be opened in a browser.  Open the menu 'Log in to myInfineon' in the upper right and select register.  Return to this page after your account is created.</p>
          </div>
        </div>
        <div class="install-tile has-account" (click)="onHasAccountClick()">
          <div class="tile-content">
            <span class="tile-icon">&#128274;</span>
            <h3>Have an Infineon Account?</h3>
            <p>Click here to log in and manage your software. A browser will open for authentication.</p>
          </div>
        </div>
      </div>
      @if (loadingTools) {
        <div class="gather-tools-message">
          <h3>Gather information on required tools ...</h3>
          <div class="spinner"></div>
        </div>
      }
      <div class="idc-launcher-note">
        <p style="font-size: 2.5rem; font-weight: 700; text-align: center; margin: 2rem 0;"><strong>Note:</strong> If the IDC Launcher Service is still installing, please wait until it is done.</p>
      </div>
    }
    @else {
      <div class="step-indicator">Step {{ step + 2 }} of 4</div>
      @switch (step) {
      @case (0) {
        <div class="install-choice-container">
          <p class="intro-text">Pick a method for installing ModusToolbox and related tools</p>
          <div class="cards-wrapper">
            <div class="choice-card" [class.selected]="installChoice==='home'" [class.disabled]="homeError" (click)="selectInstallChoice('home')">
              <div class="card-content">
                <div class="card-header">
                  <mat-icon>home</mat-icon>
                  @if (os === 'win32') {
                    <h3>Install In Default Location</h3>
                  } @else if (os === 'darwin') {
                    <h3>Install In User's Application Directory</h3>
                  } @else {
                  <h3>Install In Home Directory</h3>
                  }
                </div>
                @if (os === 'darwin') {
                  <p class="card-description">Install ModusToolbox and related tools in the user Application directory. <br><br>This is the recommended option for macOS.</p>
                } @else if (os === 'win32') {
                  <p class="card-description">Install ModusToolbox and related tools in the default locations on this machine.</p>
                } @else {
                <p class="card-description">Install ModusToolbox and related tools in the default locations on this machine.</p>
                }
              </div>
              @if (homeWarning && !homeError) { <div class="warning-text">{{ homeWarning }}</div> }
              @if (homeError) { <div class="error-text">{{ homeError }}</div> }
            </div>
              <div class="choice-card" [class.selected]="installChoice==='custom'" [class.disabled]="customError" (click)="selectInstallChoice('custom')">
                <div class="card-content">
                  <div class="card-header">
                    <mat-icon>folder_open</mat-icon>
                    @if (os === 'win32') {
                      <h3>Install In Custom Directory</h3>
                    } @else if (os === 'darwin') {
                      <h3>Install In Global Application Directory</h3>
                    } @else {
                      <h3>Install In Custom Directory</h3>
                    }
                  </div>
                  @if (os === 'darwin') {
                    <p class="card-description">Install ModusToolbox and related tools in the global Applications directory. <br><br>Administrative privileges will be required.</p>
                  } @else if (os === 'win32') {
                    <p class="card-description">Install ModusToolbox and related tools in a directory of your choosing. This directory should not contain any spaces.</p>
                  } @else {
                    <p class="card-description">Install ModusToolbox and related tools in a directory of your choosing. This directory should not contain any spaces.</p>
                  }
                  @if (os === 'win32') {
                    <p class="card-description">Install ModusToolbox and related tools in a directory of your choosing. This directory should not contain any spaces.</p>
                    <div class="custom-path-row" (click)="$event.stopPropagation()">
                      <mat-form-field appearance="outline" class="path-field">
                        <mat-label>Custom Install Path</mat-label>
                        <input matInput [disabled]="!!customError" [ngModel]="customPath" (ngModelChange)="onCustomPathInput($event)" placeholder="/path/to/modustoolbox" />
                      </mat-form-field>
                      <button mat-raised-button color="primary" (click)="browseForCustom()" [disabled]="!!customError"><mat-icon>folder</mat-icon>&nbsp;Browse</button>
                    </div>
                  }
                </div>
                @if (customWarning && !customError) { <div class="warning-text">{{ customWarning }}</div> }
                @if (customError) { <div class="error-text">{{ customError }}</div> }
              </div>
          </div>
          <div class="actions-row">
            <button mat-raised-button color="primary" (click)="locationNext()" [disabled]="disableNext || !installChoice || (installChoice==='custom' && isCustomInstallAvailable() && !customPath)">Next</button>
          </div>
          @if (justNeedTools) {
            <div style="display: flex; flex-direction: column; align-items: center; margin: 1.5rem 0;">
              <div style="max-width: 600px; text-align: center; margin-bottom: 1rem; color: #666; font-size: 1.05rem;">
                The only required package missing is the ModusToolbox tools package. If it is installed in a non-standard location, use the Select Tools button to specify the location of the tools package.
              </div>
              <button mat-raised-button color="primary" (click)="be.browseForFolder('find-tools-location', 'Tools Directory')">
                <mat-icon>folder_open</mat-icon>
                Select Tools Location
              </button>
              @if (toolsLocError) {
                <div style="display: flex; align-items: center; color: #f44336; font-weight: 600; margin-top: 1rem;">
                  <mat-icon style="margin-right: 0.5em;">error</mat-icon>
                  <span>{{ toolsLocError }}</span>
                </div>
              }
            </div>
          }
        </div>
      }
      @case (1) {
        <div class="confirm-tools">
          <h3>Confirm Tools to Download & Install</h3>
          @if (neededTools.length === 0) {
            <div class="login-message">
              <h3 style="font-size: 1.4rem; font-weight: 600; margin-bottom: 1.5rem;">Logging in to Infineon.com, a browser window may appear.</h3>
              <div class="spinner"></div>
            </div>
          } @else {
            <div class="tool-section">
              <h4 style="text-align: center; width: 100%;">Required Software</h4>
              <div style="text-align: center; font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                This list is the required minimum list of software for ModusToolbox ecosystem.  Additional software can be installed as needed from the ModusToolbox Setup program.
              </div>
              <ul class="tool-list">
              @for (tool of neededTools; track tool.featureId) {
                @if (tool.required && (!downloading || activeInstallSet.has(tool.featureId))) {
                  <li>
                    <div class="tool-info">
                      <span class="tool-name">{{ tool.name }}<br>
                      @if (tool.current) {
                         (v{{ tool.current }})
                      }
                      @else {
                        (not installed)
                      }
                      </span>
                      @if (tool.installed) {
                        <span class="tool-status installed">Already installed</span>
                        @if (tool.upgradable) {
                          <label>
                            <input type="checkbox" [(ngModel)]="upgradeSelections[tool.featureId]"> Upgrade v{{ tool.version || 'latest' }}
                          </label>
                        }
                      } @else {
                        <span class="tool-status will-install">Install v{{ tool.version }}</span>
                      }
                    </div>
                    @if (tool.featureId === 'com.ifx.tb.tool.modustoolboxprogtools' && !tool.installed && os !== 'darwin') {
                      <div class="admin-required-message">
                        <mat-icon style="color: #f44336; vertical-align: middle;">security</mat-icon>
                        <span style="color: #f44336; font-weight: 600; margin-left: 0.5em;">Administrative privileges will be required to install this tool.</span>
                      </div>
                    }
                    @if (progress[tool.featureId].message) {
                      @if (tool.installed) {
                        <div class="progress-message">Complete</div>
                        <div class="progress-bar">
                          <div class="progress-fill" style="width: 100%"></div>
                        </div>
                      } @else {
                        <div class="progress-message">{{ progress[tool.featureId].message }}</div>
                        <div class="progress-bar">
                          <div class="progress-fill" [style.width.%]="progress[tool.featureId].percent"></div>
                        </div>
                      }
                    }
                  </li>
                }
              }
            </ul>
          </div>
          <button class="next-btn" (click)="onConfirmTools()" [disabled]="disableNext || downloading">
            @if (downloading) {
              Installing...
            } @else {
              Install Now
            }
          </button>
          }
          @if (downloading) {
            <div class="downloading-message">
              <h3>Downloading and Installing Requested Software ...</h3>
              <div class="spinner"></div>
            </div>
          }
        </div>
      }
      @case (2) {
        <div class="install-complete">
          <h3>Installation Complete!</h3>
          <p>All selected tools have been downloaded and installed.</p>
          <button class="reinit-btn" (click)="onReinit()">Reinitialize Extension</button>
        </div>
      }
    }
    }
</div>