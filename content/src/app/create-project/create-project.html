<div class="create-project-container" [class.dark-theme]="themeType === 'dark'" [class.light-theme]="themeType === 'light'">
  <!-- Manifest Status Overlay -->
  @if (manifestStatus === 'loading') {
    <div class="manifest-overlay">
    <div class="manifest-message">
      @if (manifestStatus === 'loading') {
        <mat-spinner diameter="48"></mat-spinner>
        <span class="manifest-wait-text">Waiting on manifest data...</span>
      }
    </div>
    </div>
  }
  <!-- Header -->
  <div class="header">
    <h1>
      <mat-icon>add_circle_outline</mat-icon>
      Create New ModusToolbox Project
    </h1>
    <p class="subtitle">Follow the steps below to create your new embedded application</p>
  </div>

  <!-- Stepper -->
  <mat-stepper [linear]="true" #stepper class="project-stepper">
    
    <!-- Step 1: Project Information -->
    <mat-step [stepControl]="projectInfoForm" label="Project Information">
      <ng-template matStepperIcon="edit">
        <mat-icon>folder</mat-icon>
      </ng-template>
      
      <div class="step-content">
        <h2>Project Details</h2>
        <p class="step-description">Specify the project name and location</p>
        
  <form [formGroup]="projectInfoForm" class="project-form">
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Project Name</mat-label>
    <input matInput 
      formControlName="projectName" 
      placeholder="my-modustoolbox-app"
      maxlength="50"
      [disabled]="manifestStatus !== 'loaded'">
              <mat-hint>Use only letters, numbers, hyphens, and underscores</mat-hint>
              @if (projectInfoForm.get('projectName')?.hasError('required')) {
                <mat-error>
                  Project name is required
                </mat-error>
              }
              @if (projectInfoForm.get('projectName')?.hasError('hasSpaces')) {
                <mat-error>
                  Spaces are not allowed in project name
                </mat-error>
              }              
              @if (projectInfoForm.get('projectName')?.hasError('pattern')) {
                <mat-error>
                  Invalid characters in project name
                </mat-error>
              }

            </mat-form-field>
          </div>
          
          <div class="form-row">
            <div class="location-input-container">
              <mat-form-field appearance="outline" class="location-field">
                <mat-label>Project Location</mat-label>
      <input matInput 
        formControlName="projectLocation" 
        placeholder="C:\\workspace\\my-projects"
        [disabled]="manifestStatus !== 'loaded'">
                <mat-hint>Choose where to create your project</mat-hint>
                @if (projectInfoForm.get('projectLocation')?.hasError('required')) {
                  <mat-error>
                    Project location is required
                  </mat-error>
                }
                @if (projectInfoForm.get('projectLocation')?.hasError('hasSpaces')) {
                  <mat-error>
                    Spaces are not allowed in project location
                  </mat-error>
                }
              </mat-form-field>
              <button mat-raised-button 
                      type="button"
                      color="accent"
                      class="browse-button"
                      (click)="browseForDirectory()"
                      [disabled]="isLoading || manifestStatus !== 'loaded'"
                      matTooltip="Browse for directory">
                <mat-icon>folder_open</mat-icon>
                Browse
              </button>
            </div>
          </div>

          <!-- Project Path Preview -->
          @if (getProjectPath()) {
            <div class="project-path-preview">
              <mat-icon>info</mat-icon>
              <span>Project will be created at: <strong>{{ getProjectPath() }}</strong></span>
            </div>
          }
        </form>
        
        <!-- Manifest Status Error Message -->
        @if (manifestStatus === 'not-available') {
          <div class="manifest-error-message">
            <mat-icon>error</mat-icon>
            <span>No manifest data available, check your internet connection.</span>
          </div>
        }
        
  <div class="step-actions" #stepActionsSection>
          <button mat-raised-button 
                  color="primary" 
                  matStepperNext 
                  [disabled]="!projectInfoForm.valid || isLoading">
            <mat-icon>arrow_forward</mat-icon>
            Next: Select BSP
          </button>
        </div>
      </div>
    </mat-step>

    <!-- Step 2: BSP Selection -->
    <mat-step [stepControl]="bspSelectionForm" label="BSP Selection">
      <ng-template matStepperIcon="edit">
        <mat-icon>developer_board</mat-icon>
      </ng-template>
      
      <div class="step-content">
        <h2>Board Support Package</h2>
        <p class="step-description">Select the BSP category and specific board</p>
        
        <!-- Two-column layout -->
        <div class="bsp-two-column-layout">
          <!-- Left Column: Controls -->
          <div class="bsp-left-column">
            <!-- Connected Dev Kits UI -->
            <div class="devkit-bsp-section">
              <div class="devkit-list-header">
                <span class="devkit-list-title"><mat-icon>usb</mat-icon> Connected Kits ({{ filteredDevKits.length }})</span>
                <button mat-icon-button (click)="refreshKits()" [disabled]="isLoading" matTooltip="Refresh connected kits">
                  <mat-icon>refresh</mat-icon>
                </button>
              </div>
              @if (filteredDevKits.length > 0) {
                <div class="devkit-bsp-list">
                  @for (kit of filteredDevKits; track kit.serial) {
                    <div class="devkit-bsp-card" 
                         [class.selected]="selectedDevKit?.serial === kit.serial" 
                         [class.disabled]="kit.status !== 'Available'"
                         (click)="kit.status === 'Available' ? onDevKitSelect(kit) : null"
                         [style.opacity]="kit.status === 'Available' ? '1' : '0.5'"
                         [style.cursor]="kit.status === 'Available' ? 'pointer' : 'not-allowed'">
                      <div class="devkit-bsp-main" style="display: flex; flex-direction: column; justify-content: center; align-items: flex-start;">
                        <div class="devkit-name-section" style="display: flex; align-items: center; margin-bottom: 4px;">
                          <span class="devkit-label" style="display: inline-block; min-width: 60px;">Kit:</span>
                          <span class="devkit-bsp-name" style="text-decoration: none;">{{ kit.name }}</span>
                        </div>
                        <div class="devkit-bsp-section" style="display: flex; align-items: center; margin-bottom: 4px;">
                          <span class="devkit-label" style="display: inline-block; min-width: 60px;">BSP:</span>
                          <span class="devkit-bsp-value" style="text-decoration: none !important; border-bottom: none !important; text-decoration-line: none !important;">{{ kit.bsp || 'Not set' }}</span>
                        </div>
                        <div class="devkit-status-section" style="display: flex; align-items: center; margin-bottom: 4px;">
                          <span class="devkit-label" style="display: inline-block; min-width: 60px;">Status:</span>
                          <span class="devkit-status" [style.color]="kit.status === 'Available' ? 'green' : 'red'">{{ kit.status }}</span>
                        </div>
                        <div class="devkit-serial-section" style="display: flex; align-items: center;">
                          <span class="devkit-label" style="display: inline-block; min-width: 60px;">Serial:</span>
                          <span class="devkit-bsp-serial">{{ kit.serial }}</span>
                        </div>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="no-kits">No development kits connected.</div>
              }
            </div>

            <form [formGroup]="bspSelectionForm" class="bsp-form">
              <div class="form-row">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>BSP Category</mat-label>
                  <mat-select formControlName="category" 
                             (selectionChange)="onCategoryChange()"
                             [disabled]="isLoading"
                             panelClass="bsp-dropdown-panel">
                    @for (category of getBSPCategories(); track category) {
                      <mat-option [value]="category">
                        {{ category }}
                      </mat-option>
                    }
                  </mat-select>
                  <mat-hint>Choose the type of development board</mat-hint>
                  @if (bspSelectionForm.get('category')?.hasError('required')) {
                    <mat-error>
                      BSP category is required
                    </mat-error>
                  }
                </mat-form-field>
              </div>
              
              @if (selectedCategory) {
                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Board Support Package</mat-label>
                    <mat-select formControlName="bsp" 
                               (selectionChange)="onBSPChange()"
                               [disabled]="isLoading || getBSPsForSelectedCategory().length === 0"
                               panelClass="bsp-dropdown-panel">
                      @for (bsp of getBSPsForSelectedCategory(); track bsp.id) {
                        <mat-option [value]="bsp.id"
                                   (mouseenter)="onBSPHover(bsp)"
                                   (mouseleave)="onBSPLeave()">
                          {{ bsp.name }}
                        </mat-option>
                      }
                    </mat-select>
                    <mat-hint>Choose the specific development board</mat-hint>
                    @if (bspSelectionForm.get('bsp')?.hasError('required')) {
                      <mat-error>
                        BSP selection is required
                      </mat-error>
                    }
                  </mat-form-field>
                </div>
              }

              <!-- Loading indicator -->
              @if (isLoading) {
                <div class="loading-indicator">
                  <mat-spinner diameter="30"></mat-spinner>
                  <span>Loading BSPs...</span>
                </div>
              }
            </form>
          </div>
          
          <!-- Right Column: BSP Description -->
          <div class="bsp-right-column">
            @if (hoveredBSP || selectedBSP) {
              <div class="bsp-description-panel full-height">
                <div class="description-header">
                  <mat-icon>developer_board</mat-icon>
                  <span>{{ (hoveredBSP || selectedBSP)?.name }}</span>
                </div>
                @if ((hoveredBSP || selectedBSP)?.description) {
                  <div class="description-content" 
                       [innerHTML]="(hoveredBSP || selectedBSP)?.description">
                  </div>
                } @else {
                  <div class="description-content no-description">
                    No description available for this BSP.
                  </div>
                }
              </div>
            } @else {
              <div class="bsp-description-panel full-height placeholder">
                <div class="description-header">
                  <mat-icon>info</mat-icon>
                  <span>BSP Information</span>
                </div>
                <div class="description-content no-description">
                  Select a BSP to view its description and specifications.
                </div>
              </div>
            }
          </div>
        </div>
        
        <div class="step-actions">
          <button mat-button matStepperPrevious [disabled]="isLoading">
            <mat-icon>arrow_back</mat-icon>
            Back
          </button>
          <button mat-raised-button 
                  color="primary" 
                  matStepperNext 
                  [disabled]="!bspSelectionForm.valid || isLoading">
            <mat-icon>arrow_forward</mat-icon>
            Next: Select Example
          </button>
        </div>
      </div>
    </mat-step>

    <!-- Step 3: Example Selection -->
    <mat-step [stepControl]="exampleSelectionForm" label="Example Selection">
      <ng-template matStepperIcon="edit">
        <mat-icon>code</mat-icon>
      </ng-template>
      
      <div class="step-content">
        <h2>Code Example</h2>
        <p class="step-description">Choose the category and specific example for your project</p>
        
        <!-- Two-column layout -->
        <div class="example-two-column-layout">
          <!-- Left Column: Controls -->
          <div class="example-left-column">
            <form [formGroup]="exampleSelectionForm" class="example-form">
              @if (selectedBSP) {
                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Example Category</mat-label>
                    <mat-select formControlName="exampleCategory" 
                               (selectionChange)="onExampleCategoryChange()"
                               [disabled]="isLoading || getExampleCategories().length === 0"
                               panelClass="example-dropdown-panel">
                      @for (category of getExampleCategories(); track category) {
                        <mat-option [value]="category">
                          {{ category }}
                        </mat-option>
                      }
                    </mat-select>
                    <mat-hint>Select the category of code examples</mat-hint>
                    @if (exampleSelectionForm.get('exampleCategory')?.hasError('required')) {
                      <mat-error>
                        Example category is required
                      </mat-error>
                    }
                  </mat-form-field>
                </div>
              }
              
              @if (selectedExampleCategory) {
                <div class="form-row">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Example Code</mat-label>
                    <mat-select formControlName="example" 
                               (selectionChange)="onExampleChange()"
                               [disabled]="isLoading || examples.length === 0"
                               panelClass="example-dropdown-panel">
                      @for (example of examples; track example.id) {
                        <mat-option [value]="example.id"
                                   (mouseenter)="onExampleHover(example)"
                                   (mouseleave)="onExampleLeave()">
                            {{ example.name }}
                        </mat-option>
                      }
                    </mat-select>
                    <mat-hint>Select a specific code example to start with</mat-hint>
                    @if (exampleSelectionForm.get('example')?.hasError('required')) {
                      <mat-error>
                        Example selection is required
                      </mat-error>
                    }
                  </mat-form-field>
                </div>
              }

              <!-- Loading indicator -->
              @if (isLoading) {
                <div class="loading-indicator">
                  <mat-spinner diameter="30"></mat-spinner>
                  <span>Loading examples...</span>
                </div>
              }
            </form>
          </div>
          
          <!-- Right Column: Example Description -->
          <div class="example-right-column">
            @if (hoveredExample || selectedExample) {
              <div class="example-description-panel full-height">
                <div class="description-header">
                  <mat-icon>code</mat-icon>
                  <span>{{ (hoveredExample || selectedExample)?.name }}</span>
                </div>
                @if ((hoveredExample || selectedExample)?.description) {
                  <div class="description-content" 
                       [innerHTML]="(hoveredExample || selectedExample)?.description">
                  </div>
                } @else {
                  <div class="description-content no-description">
                    No description available for this example.
                  </div>
                }
              </div>
            } @else {
              <div class="example-description-panel full-height placeholder">
                <div class="description-header">
                  <mat-icon>info</mat-icon>
                  <span>Example Information</span>
                </div>
                <div class="description-content no-description">
                  Select an example to view its description and details.
                </div>
              </div>
            }
          </div>
        </div>
        
        <div class="step-actions">
          <button mat-button matStepperPrevious [disabled]="isLoading">
            <mat-icon>arrow_back</mat-icon>
            Back
          </button>
          <button mat-raised-button 
                  color="primary" 
                  matStepperNext 
                  [disabled]="!exampleSelectionForm.valid || isLoading">
            <mat-icon>arrow_forward</mat-icon>
            Review & Create
          </button>
        </div>
      </div>
    </mat-step>

    <!-- Step 4: Review & Create -->
    <mat-step label="Create Project">
      <ng-template matStepperIcon="edit">
        <mat-icon>check_circle</mat-icon>
      </ng-template>
      
      <div class="step-content">
        <h2>Review Your Project</h2>
        <p class="step-description">Confirm your selections and create the project</p>
        
        <div class="review-section">
          <mat-card class="review-card">
            <mat-card-header>
              <mat-card-title>Project Summary</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="review-item">
                <strong>Project Name:</strong> {{ projectInfoForm.value.projectName }}
              </div>
              <div class="review-item">
                <strong>Location:</strong> {{ projectInfoForm.value.projectLocation }}
              </div>
              <div class="review-item">
                <strong>Full Path:</strong> {{ getProjectPath() }}
              </div>
              
              <mat-divider></mat-divider>
              
              <div class="review-item bsp-category-item">
                <strong>BSP Category:</strong> {{ selectedCategory }}
              </div>
              <div class="review-item bsp-board-item">
                <strong>Board:</strong> {{ selectedBSP?.name }}
              </div>
              <div class="review-item bsp-device-item">
                <strong>Device:</strong> {{ selectedBSP?.device }}
              </div>
              <div class="review-item bsp-connectivity-item">
                <strong>Connectivity:</strong> {{ selectedBSP?.connectivity }}
              </div>
              
              <mat-divider></mat-divider>
              
              <div class="review-item">
                <strong>Example Category:</strong> {{ selectedExampleCategory }}
              </div>
              <div class="review-item">
                <strong>Code Example:</strong> {{ selectedExample?.name }}
              </div>
              @if (selectedExample?.description) {
                <div class="review-item">
                  <strong>Description:</strong> 
                  <span [innerHTML]="selectedExample?.description"></span>
                </div>
              }
            </mat-card-content>
          </mat-card>
        </div>
        
        <!-- Success Card -->
        @if (projectCreated) {
          <div class="success-section">
            <mat-card class="success-card">
              <mat-card-header>
                <div mat-card-avatar class="success-avatar">
                  <mat-icon>check_circle</mat-icon>
                </div>
                <mat-card-title>Project Created Successfully!</mat-card-title>
                <mat-card-subtitle>Your ModusToolbox project is ready</mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="success-item">
                  <mat-icon>folder</mat-icon>
                  <span>Project location: <strong>{{ projectPath }}</strong></span>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        }
        
        <!-- Progress Section -->
        @if (isLoading) {
          <div class="progress-section" #progressSection>
            <mat-card class="progress-card">
              <mat-card-header>
                <div mat-card-avatar class="progress-avatar">
                  <mat-icon>construction</mat-icon>
                </div>
                <mat-card-title>Creating Your Project</mat-card-title>
                <mat-card-subtitle>{{ progressMessage }}</mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="progress-container">
                  <mat-progress-bar 
                    mode="determinate" 
                    [value]="progressValue"
                    color="primary">
                  </mat-progress-bar>
                  <div class="progress-text">
                    {{ progressValue.toFixed(0) }}% Complete
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        }
        
        <div class="step-actions">
          <button mat-button matStepperPrevious [disabled]="isLoading">
            <mat-icon>arrow_back</mat-icon>
            Back
          </button>
          @if (projectCreated) {
            <button mat-raised-button 
                    color="accent" 
                    (click)="loadProject()">
              <mat-icon>folder_open</mat-icon>
              Load Project
            </button>
          } @else {
            <button mat-raised-button 
                    color="primary" 
                    (click)="createProject()"
                    [disabled]="isLoading">
              @if (!isLoading) {
                <mat-icon>rocket_launch</mat-icon>
              }
              {{ isLoading ? 'Creating Project...' : 'Create Project' }}
            </button>
          }
        </div>
      </div>
    </mat-step>
  </mat-stepper>
</div>
