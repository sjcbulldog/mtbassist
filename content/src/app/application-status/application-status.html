<div class="application-status" [class.dark-theme]="themeType === 'dark'" [class.light-theme]="themeType === 'light'">
  @if (isLoading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading application status...</p>
    </div>
  }

  @if (!isLoading && !hasError && applicationStatus) {
    <div class="content">
    <mat-tab-group class="status-tabs">
      <!-- Application Information Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>dashboard</mat-icon>
          Application
        </ng-template>

        <!-- Application Tab Title Row with Right-Aligned Help Icon -->
        <div class="application-title-row" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
          <span class="application-title" style="font-size: 1.5em; font-weight: bold;">Application Status</span>
          <button mat-icon-button (click)="refreshApplicationData()" [disabled]="isLoading" matTooltip="Refresh application data">
            <mat-icon>refresh</mat-icon>
          </button>
        </div>

        <div class="tab-content">
          <!-- Application Overview -->
          <div class="overview-section">
            <div class="app-info">
              <div class="app-dir-row" style="display: flex; align-items: center; justify-content: space-between;">
                <h3 style="margin: 0;">Application Directory: <span class="app-dir">{{ applicationStatus.name }}</span></h3>
                <span class="toolsdir-display" style="margin-left: 24px; font-size: 1rem; color: #1976d2;">Tools Directory: <strong>{{ applicationStatus.toolsdir }}</strong></span>
                <mat-icon
                  matTooltip="This is a ModusToolboxc Application.  A ModusToolbox application consists of multiple projects, each of which builds to an indepenent ELF file.  These ELF files are then combined into a single HEX file to program into the device.  Each project is represented by a project view which can be selected via the navigation bar above."
                  class="application-help-icon"
                  style="vertical-align: middle; cursor: pointer; margin-left: 8px;"
                >help_outline</mat-icon>
              </div>
              <div class="app-status-row" style="display: flex; align-items: center; justify-content: flex-start; flex-wrap: wrap; gap: 16px;">
                <span class="status-label">Status:</span>
                <span class="status-badge" [ngClass]="applicationStatus.valid ? 'status-valid' : 'status-invalid'">
                  <mat-icon class="status-icon" [ngClass]="applicationStatus.valid ? 'icon-valid' : 'icon-invalid'">
                    {{ applicationStatus.valid ? 'check_circle' : 'error' }}
                  </mat-icon>
                  <span class="status-text">{{ applicationStatus.valid ? 'ModusToolbox Project Loaded' : 'No ModusToolbox Project Loaded' }}</span>
                </span>
                <span class="status-date">Checked: {{ currentDate | date:'medium' }}</span>
                
                <!-- Configuration Selector aligned to the right -->
                <div class="config-selector" style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                  <mat-form-field appearance="outline" style="width: 120px; font-size: 0.875rem;">
                    <mat-label>Config</mat-label>
                    <mat-select [value]="applicationStatus.configuration" (selectionChange)="onConfigurationChange($event.value)">
                      @for (config of configurationOptions; track config) {
                        <mat-option [value]="config">{{ config }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                  <mat-icon
                    matTooltip="Selecting a configuration causes the complete application to be built with that configuration. The configuration can either be Debug or Release. Selecting None causes no configuration to be specified. Therefore, the default from the make files will be used. Select none, and then edit the CONFIG value in each make file to get a mix of Debug and Release builds."
                    class="config-help-icon"
                    style="cursor: pointer; margin-left: 4px;"
                  >help_outline</mat-icon>
                </div>
              </div>
              
              @if (applicationStatus.generalMessage && typeof applicationStatus.generalMessage === 'string') {
                <div class="tasks-warning" style="margin-top: 1em; margin-bottom: 1em; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 12px; display: flex; align-items: center;">
                  <mat-icon color="warn" style="margin-right: 8px;">warning</mat-icon>
                  <span style="flex: 1; font-weight: 500; color: #856404;">{{ applicationStatus.generalMessage }}</span>
                  <mat-icon
                    matTooltip="This is an important message related to your application."
                    class="tasks-help-icon"
                    style="cursor: pointer; margin-right: 8px; color: #856404;"
                  >help_outline</mat-icon>
                  <button mat-raised-button color="primary" (click)="handleGeneralMessageButton()" [disabled]="running">
                    {{ applicationStatus.generalMessageButtonText || 'Take Action' }}
                  </button>
                </div>
              }
              
              @if (applicationStatus.needVSCode) {
                <div class="tasks-warning" style="margin-top: 1em; margin-bottom: 1em; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 12px; display: flex; align-items: center;">
                  <mat-icon color="warn" style="margin-right: 8px;">warning</mat-icon>
                  <span style="flex: 1; font-weight: 500; color: #856404;">This application has not been setup to run in VS Code. Press the Prepare For VSCode button to prepare this application.</span>
                  <mat-icon
                    matTooltip="The ModusToolbox Assistant needs to prepare this application for VS Code before tasks and other features are available."
                    class="tasks-help-icon"
                    style="cursor: pointer; margin-right: 8px; color: #856404;"
                  >help_outline</mat-icon>
                  <button mat-raised-button color="primary" (click)="prepareVSCode()" [disabled]="running">Prepare For VSCode</button>
                </div>
              } @else if (applicationStatus.vscodeTasksStatus !== 'good') {
                <div class="tasks-warning" style="margin-top: 1em; margin-bottom: 1em; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 12px; display: flex; align-items: center;">
                  <mat-icon color="warn" style="margin-right: 8px;">warning</mat-icon>
                  <span style="flex: 1; font-weight: 500; color: #856404;">
                    @if (applicationStatus.vscodeTasksStatus === 'missing') {
                      The VS Code tasks.json file is missing.  Press 'Fix Tasks' to create a new tasks file with the required tasks.
                    } @else if (applicationStatus.vscodeTasksStatus === 'corrupt') {
                      The .vscode file is corrupt and cannot be read.  Press 'Fix Tasks' to create a new tasks file.
                    } @else {
                      Some required VS Code tasks are missing or incorrect.  Press the 'Fix Tasks' button to add and/or update these tasks.
                    }
                  </span>
                  <mat-icon
                    matTooltip="The ModusToolbox Assistant relies on specific tasks to be available in the VS Code tasks.json file.  Press the 'Fix Tasks' button to generate any of these that are missing."
                    class="tasks-help-icon"
                    style="cursor: pointer; margin-right: 8px; color: #856404;"
                  >help_outline</mat-icon>
                  <button mat-raised-button color="primary" (click)="fixTasks()" [disabled]="running">Fix Tasks</button>
                </div>
              }
              
              @if (applicationStatus.vscodeSettingsStatus !== 'good') {
                <div class="settings-warning" style="margin-top: 1em; margin-bottom: 1em; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 12px; display: flex; align-items: center;">
                  <mat-icon color="warn" style="margin-right: 8px;">warning</mat-icon>
                  <span style="flex: 1; font-weight: 500; color: #856404;">
                    @if (applicationStatus.vscodeSettingsStatus === 'missing') {
                      The VS Code settings.json file is missing.  Press 'Fix Settings' to create a new settings file with the required settings.
                    } @else if (applicationStatus.vscodeSettingsStatus === 'corrupt') {
                      The .vscode settings file is corrupt and cannot be read.  Press 'Fix Settings' to create a new settings file.
                    } @else {
                      Some required VS Code settings are missing or incorrect.  Press the 'Fix Settings' button to add and/or update these settings.
                    }
                  </span>
                  <mat-icon
                    matTooltip="The ModusToolbox Assistant relies on specific settings to be available in the VS Code settings.json file.  Press the 'Fix Settings' button to generate any of these that are missing."
                    class="settings-help-icon"
                    style="cursor: pointer; margin-right: 8px; color: #856404;"
                  >help_outline</mat-icon>
                  <button mat-raised-button color="primary" (click)="fixSettings()" [disabled]="running">Fix Settings</button>
                </div>
              }
              
              <!-- Application Build & Tool Actions -->
              @if (applicationStatus.valid) {
                <div class="app-build-actions app-build-actions-flex">
                  <div class="app-build-actions-left">
                    <button mat-raised-button class="app-build-btn build-btn" (click)="buildApplication()" [disabled]="running">
                      <mat-icon>build</mat-icon>
                      Build
                    </button>
                    <button mat-raised-button class="app-build-btn rebuild-btn" (click)="rebuildApplication()" [disabled]="running">
                      <mat-icon>refresh</mat-icon>
                      Rebuild
                    </button>
                    <button mat-raised-button class="app-build-btn clean-btn" (click)="cleanApplication()" [disabled]="running">
                      <mat-icon>cleaning_services</mat-icon>
                      Clean
                    </button>
                    <button mat-raised-button class="app-build-btn erase-btn" (click)="eraseApplication()" [disabled]="running">
                      <mat-icon>delete</mat-icon>
                      Erase
                    </button>
                    <button mat-raised-button class="app-build-btn program-btn" 
                            (click)="programApplication()" 
                            [disabled]="running">
                      <mat-icon>download</mat-icon>
                      Program
                    </button>
                    <button mat-raised-button class="app-build-btn readme-btn" (click)="viewReadme()" [disabled]="running">
                      <mat-icon>description</mat-icon>
                      README.md
                    </button>
                  </div>
                  <span class="app-build-actions-spacer"></span>
                  <div class="app-build-actions-right">
                    <button mat-raised-button class="app-build-btn device-configurator-btn" (click)="openDeviceConfigurator()" [disabled]="running">
                      <mat-icon>settings_input_component</mat-icon>
                      Device Configurator
                    </button>
                    <button mat-raised-button class="app-build-btn library-manager-btn" (click)="openLibraryManager()" [disabled]="running">
                      <mat-icon>library_books</mat-icon>
                      Library Manager
                    </button>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Memory Usage Section -->
          @if (applicationStatus.valid && memoryUsageData.length > 0) {
            <app-memory-usage [memoryUsageData]="memoryUsageData" [collapsedStates]="memoryCollapsedStates"></app-memory-usage>
          } @else if (applicationStatus.valid && memoryUsageData.length === 0) {
            <div class="memory-usage-section">
              <div class="memory-usage-card">
                <div class="memory-header-container" style="display: flex; align-items: center;">
                  <h3 class="collapsible-header" style="flex: 1; margin: 0; cursor: pointer;" (click)="noMemoryCollapsed = !noMemoryCollapsed">
                    <mat-icon class="collapse-icon" [class.collapsed]="noMemoryCollapsed">expand_more</mat-icon>
                    Memory Usage
                  </h3>
                  <mat-icon
                    matTooltip="This shows the combined memory usage across all of the projects using the latest build. This means if a latest build was a DEBUG build that will be used. This is per project so there can be a mix of DEBUG and RELEASE builds depending on what was built last."
                    class="memory-help-icon"
                    style="cursor: pointer; margin-left: 8px;"
                  >help_outline</mat-icon>
                </div>
                <div class="memory-usage-container" [class.collapsed]="noMemoryCollapsed">
                  <ng-container *ngIf="!noMemoryCollapsed">
                    <div class="no-memory-data">
                      <p>A sucessful build is needed to display memory usage.</p>
                    </div>
                  </ng-container>
                </div>
              </div>
            </div>
          }

          <!-- Application Documentation Section -->
          @if (applicationStatus.valid) {
            <div class="documentation-section">
              <h3 class="collapsible-header" (click)="toggleSection('application', 'documentation')">
                <mat-icon class="collapse-icon" [class.collapsed]="isSectionCollapsed('application', 'documentation')">
                  expand_more
                </mat-icon>
                Application Documentation
              </h3>
              <div class="doc-grid" [class.collapsed]="isSectionCollapsed('application', 'documentation')">
                @for (doc of applicationStatus.documentation; track doc.name) {
                  <div class="doc-item" (click)="openDocument(doc)">
                    <div class="doc-info">
                      <h4>{{ doc.name }}</h4>
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          @if (applicationStatus.valid) {
            <div class="tools-section">
              <h3 class="collapsible-header" (click)="toggleSection('application', 'tools')">
                <mat-icon class="collapse-icon" [class.collapsed]="isSectionCollapsed('application', 'tools')">
                  expand_more
                </mat-icon>
                Application Tools
              </h3>
              <div class="tools-grid" [class.collapsed]="isSectionCollapsed('application', 'tools')">
                @for (tool of applicationStatus.tools; track tool.name) {
                  <div class="tool-item"  (click)="onToolClick(null, tool)">
                    <div class="tool-header">
                      <div class="tool-info">
                        <h4 style="color: black;">{{ tool.name }}</h4>
                        @if (tool.version) {
                          <div class="tool-meta">
                            <span class="version">v{{ tool.version }}</span>
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </mat-tab>

      <!-- Project Tabs -->
      @for (project of applicationStatus.projects; track project.name) {
        <mat-tab>
          <ng-template mat-tab-label>
            <span>ðŸ“¦</span>
            {{ project.name }}
            @if (hasMissingAssets(project)) {
              <mat-icon class="missing-assets-tab-icon" matTooltip="This project has missing assets">warning</mat-icon>
            }
          </ng-template>
        
        <div class="tab-content">
          <!-- Project Overview -->
          <div class="project-overview">
            <div class="project-info">
              <div class="project-title-row">
                <h3>Project: {{ project.name }}</h3>
                <div class="intellisense-checkbox-row">
                  <label class="intellisense-checkbox-label">
                    <input type="checkbox"
                      [checked]="intellisenseProject === project.name"
                      (change)="onIntellisenseProjectChange(project.name)"
                    />
                    <span>Intellisense Project</span>
                  </label>
            <mat-icon
              matTooltip="In ModusToolbox, VS Code intellisense works best when the CLANGD backend is used and intellisense is focused on one of the many projects that make up a ModusToolbox application.  Checking this box makes this project the focus of intellisense."
              class="intellisense-help-icon"
              style="vertical-align: middle; cursor: pointer; margin-left: 4px;"
            >help_outline</mat-icon>
                </div>
              </div>
              <!-- Project details (version, type, status, last build) removed as requested -->
              
              <!-- Project Build Actions -->
              <div class="project-build-actions">
                <button mat-raised-button class="project-build-btn build-btn" (click)="buildProject(project)" [disabled]="running">
                  <mat-icon>build</mat-icon>
                  Build
                </button>
                <button mat-raised-button class="project-build-btn rebuild-btn" (click)="rebuildProject(project)" [disabled]="running">
                  <mat-icon>refresh</mat-icon>
                  Rebuild
                </button>
                <button mat-raised-button class="project-build-btn clean-btn" (click)="cleanProject(project)" [disabled]="running">
                  <mat-icon>cleaning_services</mat-icon>
                  Clean
                </button>
                <button mat-raised-button class="project-build-btn program-btn" 
                        (click)="programProject(project)" 
                        [disabled]="running">
                  <mat-icon>download</mat-icon>
                  Program
                </button>
              </div>
              
              <!-- Missing Assets Indicator -->
              @if (hasMissingAssets(project)) {
                <div class="missing-assets-indicator">
                  <div class="warning-badge">
                    <mat-icon class="warning-icon">warning</mat-icon>
                    <span class="warning-text">Missing Assets</span>
                  </div>
                  <div class="missing-actions">
                    <button 
                      class="fix-assets-button" 
                      [disabled]="isFixingAssets(project)"
                      (click)="fixMissingAssets(project)">
                      @if (isFixingAssets(project)) {
                        <mat-icon>hourglass_empty</mat-icon>
                        Running...
                      } @else {
                        <mat-icon>build</mat-icon>
                        Fix Missing Assets
                      }
                    </button>
                    @if (isFixingAssets(project) && getCurrentlyLoadingAsset(project)) {
                      <div class="loading-asset-indicator">
                        <div class="loading-spinner"></div>
                        <span class="loading-text">Loaded: {{ getCurrentlyLoadingAsset(project) }}</span>
                      </div>
                    }
                  </div>
                </div>
              }

                <!-- Components Section (Collapsible) -->
                <div class="components-section">
                  <h3 class="collapsible-header" (click)="toggleSection(project.name, 'components')">
                    <mat-icon class="collapse-icon" [class.collapsed]="isSectionCollapsed(project.name, 'components')">
                      expand_more
                    </mat-icon>
                    Enabled Components
                    <mat-icon matTooltip="Components are a feature of the ModusToolbox middleware that enables specific features of a given middleware library." style="vertical-align: middle; cursor: help; margin-left: 0.5em;" color="primary">help_outline</mat-icon>
                  </h3>
                  <div class="enabled-components-tags" [class.collapsed]="isSectionCollapsed(project.name, 'components')">
                    @if (project.components && project.components.length > 0) {
                      @for (component of project.components; track component.name) {
                        <span class="component-tag" [title]="component.description || 'No Description Found'">
                          <mat-icon class="component-icon">extension</mat-icon>
                          <span class="component-name">{{ component.name }}</span>
                        </span>
                      }
                    } @else {
                      <span class="no-enabled-components">No enabled components found.</span>
                    }
                  </div>
                </div>
            </div>
          </div>

          <!-- Project Documentation -->
          <div class="documentation-section">
            <h3 class="collapsible-header" (click)="toggleSection(project.name, 'documentation')">
              <mat-icon class="collapse-icon" [class.collapsed]="isSectionCollapsed(project.name, 'documentation')">
                expand_more
              </mat-icon>
              Project Documentation
            </h3>
            <div class="doc-grid" [class.collapsed]="isSectionCollapsed(project.name, 'documentation')">
              @for (doc of project.documentation; track doc.name) {
                <div class="doc-item" (click)="openDocument(doc)">
                  <div class="doc-info">
                    <h4>{{ doc.name }}</h4>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Project Middleware -->
          <div class="middleware-section">
            <h3 class="collapsible-header" (click)="toggleSection(project.name, 'middleware')">
              <mat-icon class="collapse-icon" [class.collapsed]="isSectionCollapsed(project.name, 'middleware')">
                expand_more
              </mat-icon>
              Project Middleware
            </h3>
            <div class="middleware-grid" [class.collapsed]="isSectionCollapsed(project.name, 'middleware')">
              @for (middleware of project.middleware; track middleware.name) {
                <div class="middleware-item" [class.missing-middleware]="isMiddlewareMissing(project, middleware.name)" (click)="onMiddlewareClick(project, middleware)">
                  <div class="middleware-header">
                    <div class="middleware-info">
                      <h4>{{ middleware.name }}</h4>
                      <span class="version">{{ middleware.version }}</span>
                      @if (middleware.newer) {
                        <div class="newer-version-indicator">
                          <mat-icon class="newer-icon">update</mat-icon>
                          <span class="newer-text">Update Available</span>
                        </div>
                      }
                      @if (isMiddlewareMissing(project, middleware.name)) {
                        <div class="missing-indicator">
                          <mat-icon class="missing-icon">warning</mat-icon>
                          <span class="missing-text">Missing</span>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Project Tools -->
          <div class="tools-section">
            <h3 class="collapsible-header" (click)="toggleSection(project.name, 'tools')">
              <mat-icon class="collapse-icon" [class.collapsed]="isSectionCollapsed(project.name, 'tools')">
                expand_more
              </mat-icon>
              Tools
            </h3>
            <div class="tools-grid" [class.collapsed]="isSectionCollapsed(project.name, 'tools')">
              @for (tool of project.tools; track tool.name) {
                <div class="tool-item" (click)="onToolClick(project, tool)">
                  <div class="tool-header">
                    <div class="tool-info">
                      <div class="tool-name">
                        <h4>{{ tool.name }}</h4>
                      </div>
                      <div class="tool-meta">
                        <span class="version">v{{ tool.version }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </mat-tab>
      }
    </mat-tab-group>
    </div>
  }
  @else {
    <div class="no-status">
      <mat-icon>info</mat-icon>
      <p>No application status available.</p>
    </div>
  }

  <!-- LLVM Installer Overlay -->
  @if (displayLLVMInstallControl) {
    <app-llvm-installer (close)="closeLLVMInstaller()"></app-llvm-installer>
  }
</div>
