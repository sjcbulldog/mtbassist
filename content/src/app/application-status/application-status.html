<div class="application-status" [class.dark-theme]="themeType === 'dark'" [class.light-theme]="themeType === 'light'">
  @if (isLoading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p class="loading-message">Loading Application</p>
    </div>
  }

  @if (!isLoading && !hasError && applicationStatus) {
    <div class="content">
    <mat-tab-group class="status-tabs">
      <!-- Application Information Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>dashboard</mat-icon>
          Application
        </ng-template>

        <div class="tab-content">
          @if (!applicationStatus.valid) {
            <!-- No Valid Application Message -->
            <div class="no-application-message">
              <mat-icon class="info-icon">info</mat-icon>
              <h2>No Valid ModusToolbox Application</h2>
              <p>A valid ModusToolbox application is not currently loaded.</p>
              <p>Please open a ModusToolbox application to view its status and perform actions.</p>
            </div>
          } @else {
          <!-- Application Overview Card -->
          <div class="overview-section">
            <div class="app-info-card">
              <!-- Header Section -->
              <div class="app-header">
                <div class="app-identity">
                  <button mat-icon-button (click)="refreshApplicationData()" [disabled]="isLoading" matTooltip="Refresh application data" class="refresh-btn">
                    <mat-icon>refresh</mat-icon>
                  </button>
                  <div class="app-details">
                    <div class="app-name-section">
                      <h2 class="app-name">{{ applicationStatus.name }}</h2>
                      @if (applicationStatus.readme && applicationStatus.readme.length > 0) {
                        <button mat-icon-button (click)="viewReadme()" [disabled]="running" matTooltip="View README.md" class="readme-btn">
                          <mat-icon>description</mat-icon>
                        </button>
                      }
                    </div>
                    <div class="app-paths">
                      <div class="path-item">
                        <mat-icon>folder</mat-icon>
                        <span class="path-label">Application</span>
                        <span class="path-value">{{ applicationStatus.name }}</span>
                      </div>
                      <div class="path-item">
                        <mat-icon>build</mat-icon>
                        <span class="path-label">Toolsdir</span>
                        <span class="path-value">{{ applicationStatus.toolsdir }}</span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="app-controls">
                  <div class="config-controls">
                    <mat-form-field appearance="outline" class="config-field">
                      <mat-label>Configuration</mat-label>
                      <mat-select [value]="applicationStatus.configuration" (selectionChange)="onConfigurationChange($event.value)">
                        @for (config of configurationOptions; track config) {
                          <mat-option [value]="config">{{ config }}</mat-option>
                        }
                      </mat-select>
                    </mat-form-field>
                    <mat-icon
                      matTooltip="Selecting a configuration causes the complete application to be built with that configuration. The configuration can either be Debug or Release."
                      class="config-help-icon">
                      help_outline
                    </mat-icon>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Warning Messages -->
            <div class="warning-messages">
              @if (applicationStatus.generalMessage && typeof applicationStatus.generalMessage === 'string') {
                <div class="warning-card general-warning">
                  <div class="warning-content">
                    <mat-icon class="warning-icon">warning</mat-icon>
                    <div class="warning-text">
                      <span class="warning-message">{{ applicationStatus.generalMessage }}</span>
                    </div>
                    <button mat-raised-button color="primary" (click)="handleGeneralMessageButton()" [disabled]="running" class="warning-action">
                      {{ applicationStatus.generalMessageButtonText || 'Take Action' }}
                    </button>
                  </div>
                </div>
              }
              
              @if (applicationStatus.needVSCode) {
                <div class="warning-card vscode-warning">
                  <div class="warning-content">
                    <mat-icon class="warning-icon">warning</mat-icon>
                    <div class="warning-text">
                      <span class="warning-message">This application has not been setup to run in VS Code. Prepare this application to enable VS Code features.</span>
                    </div>
                    <button mat-raised-button color="primary" (click)="prepareVSCode()" [disabled]="running" class="warning-action">
                      Prepare For VSCode
                    </button>
                  </div>
                </div>
              } @else if (applicationStatus.vscodeTasksStatus !== 'good') {
                <div class="warning-card tasks-warning">
                  <div class="warning-content">
                    <mat-icon class="warning-icon">warning</mat-icon>
                    <div class="warning-text">
                      <span class="warning-message">
                        @if (applicationStatus.vscodeTasksStatus === 'missing') {
                          VS Code tasks.json file is missing. Create required tasks file.
                        } @else if (applicationStatus.vscodeTasksStatus === 'corrupt') {
                          VS Code tasks file is corrupt. Create a new tasks file.
                        } @else {
                          Some VS Code tasks are missing or incorrect. Update tasks configuration.
                        }
                      </span>
                    </div>
                    <button mat-raised-button color="primary" (click)="fixTasks()" [disabled]="running" class="warning-action">
                      Fix Tasks
                    </button>
                  </div>
                </div>
              }
              
              @if (applicationStatus.vscodeSettingsStatus !== 'good') {
                <div class="warning-card settings-warning">
                  <div class="warning-content">
                    <mat-icon class="warning-icon">warning</mat-icon>
                    <div class="warning-text">
                      <span class="warning-message">
                        @if (applicationStatus.vscodeSettingsStatus === 'missing') {
                          VS Code settings.json file is missing. Create required settings file.
                        } @else if (applicationStatus.vscodeSettingsStatus === 'corrupt') {
                          VS Code settings file is corrupt. Create a new settings file.
                        } @else {
                          Some VS Code settings are missing or incorrect. Update settings configuration.
                        }
                      </span>
                    </div>
                    <button mat-raised-button color="primary" (click)="fixSettings()" [disabled]="running" class="warning-action">
                      Fix Settings
                    </button>
                  </div>
                </div>
              }
            </div>

            <!-- Actions Section -->
            @if (applicationStatus.valid) {
              <div class="actions-section">
                <!-- Build Actions -->
                <div class="action-group">
                  <div class="action-buttons-container">
                    <div class="action-buttons">
                      <button mat-raised-button class="action-btn primary-action" (click)="buildApplication()" [disabled]="running">
                        <mat-icon>build</mat-icon>
                        Build
                      </button>
                      <button mat-raised-button class="action-btn" (click)="rebuildApplication()" [disabled]="running">
                        <mat-icon>refresh</mat-icon>
                        Rebuild
                      </button>
                      <button mat-raised-button class="action-btn" (click)="cleanApplication()" [disabled]="running">
                        <mat-icon>cleaning_services</mat-icon>
                        Clean
                      </button>
                      <button mat-raised-button 
                              class="action-btn" 
                              (click)="eraseApplication(isEraseAll)" 
                              (contextmenu)="openEraseMenu($event)" 
                              [disabled]="running"
                              matTooltip="Erase the device. Right-click to choose between Erase (internal memory only) and Erase All (internal and external memory).">
                        <mat-icon>delete</mat-icon>
                        {{ isEraseAll ? 'Erase All' : 'Erase' }}
                      </button>
                      <div style="position: relative; display: inline-block;">
                        <button id="hiddenEraseTrigger" [style.visibility]="'hidden'" [style.position]="'absolute'" 
                                [matMenuTriggerFor]="eraseMenu" 
                                #eraseMenuTrigger="matMenuTrigger"></button>
                        <mat-menu #eraseMenu="matMenu" [hasBackdrop]="true">
                          <button mat-menu-item (click)="toggleEraseMode(false)">
                            <mat-icon>{{ !isEraseAll ? 'check' : '' }}</mat-icon>
                            <span>Erase</span>
                          </button>
                          <button mat-menu-item (click)="toggleEraseMode(true)">
                            <mat-icon>{{ isEraseAll ? 'check' : '' }}</mat-icon>
                            <span>Erase All</span>
                          </button>
                        </mat-menu>
                      </div>
                      <button mat-raised-button 
                              class="action-btn program-action" 
                              (click)="programApplication(isQuickProgram)" 
                              (contextmenu)="openProgramMenu($event)" 
                              [disabled]="running"
                              matTooltip="Program the device. Right-click to choose between Program and Quick Program modes.">
                        <mat-icon>download</mat-icon>
                        {{ isQuickProgram ? 'Quick Program' : 'Program' }}
                      </button>
                      <div style="position: relative; display: inline-block;">
                        <button id="hiddenProgramTrigger" [style.visibility]="'hidden'" [style.position]="'absolute'" 
                                [matMenuTriggerFor]="programMenu" 
                                #programMenuTrigger="matMenuTrigger"></button>
                        <mat-menu #programMenu="matMenu" [hasBackdrop]="true">
                          <button mat-menu-item (click)="toggleProgramMode(false)">
                            <mat-icon>{{ !isQuickProgram ? 'check' : '' }}</mat-icon>
                            <span>Program</span>
                          </button>
                          <button mat-menu-item (click)="toggleProgramMode(true)">
                            <mat-icon>{{ isQuickProgram ? 'check' : '' }}</mat-icon>
                            <span>Quick Program</span>
                          </button>
                        </mat-menu>
                      </div>
                    <div class="config-buttons">
                      <button mat-raised-button class="action-btn" (click)="openDeviceConfigurator()" [disabled]="running">
                        <mat-icon>settings_input_component</mat-icon>
                        Configure Device
                      </button>
                      <button mat-raised-button class="action-btn" (click)="openLibraryManager()" [disabled]="running">
                        <mat-icon>library_books</mat-icon>
                        Configure Middleware
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Quick Tasks -->
                @if (availableTasks && availableTasks.length > 0) {
                  <div class="action-group">
                    <h3 class="action-group-title">
                      <mat-icon>flash_on</mat-icon>
                      Quick Tasks
                    </h3>
                    <div class="task-buttons">
                      @for (task of availableTasks; track task.description) {
                        <button mat-raised-button 
                                class="task-btn" 
                                (click)="onTaskSelection(task.description)" 
                                [disabled]="running">
                          {{ task.description }}
                        </button>
                      }
                    </div>
                  </div>
                }
                </div>
              </div>
            }
          </div>

          <!-- Memory Usage Section -->
          @if (applicationStatus.valid && memoryUsageData && memoryUsageData.length > 0) {
            <app-memory-usage [memoryUsageData]="memoryUsageData" [collapsedStates]="memoryCollapsedStates"></app-memory-usage>
          } @else if (applicationStatus.valid && memoryUsageData && memoryUsageData.length === 0) {
            <div class="documentation-section">
              <div class="memory-header-container" style="display: flex; align-items: center;">
                <h3 class="collapsible-header" style="flex: 1; margin: 0; cursor: pointer;" (click)="noMemoryCollapsed = !noMemoryCollapsed">
                  <mat-icon class="collapse-icon" [class.collapsed]="noMemoryCollapsed">expand_more</mat-icon>
                  Memory
                </h3>
                <mat-icon
                  matTooltip="This shows the combined memory usage across all of the projects using the latest build. This means if a latest build was a DEBUG build that will be used. This is per project so there can be a mix of DEBUG and RELEASE builds depending on what was built last."
                  class="memory-help-icon"
                  style="cursor: pointer; margin-left: 8px;"
                >help_outline</mat-icon>
              </div>
              <div class="memory-usage-container" [class.collapsed]="noMemoryCollapsed">
                <ng-container *ngIf="!noMemoryCollapsed">
                  <div class="no-memory-data">
                    <p>A sucessful build is needed to display memory usage.</p>
                  </div>
                </ng-container>
              </div>
            </div>
          }

          <!-- Application Documentation Section -->
          @if (applicationStatus.valid) {
            <div class="documentation-section">
              <h3 class="collapsible-header" (click)="toggleSection('application', 'documentation')">
                <mat-icon class="collapse-icon" [class.collapsed]="isSectionCollapsed('application', 'documentation')">
                  expand_more
                </mat-icon>
                Documents
              </h3>
              <div class="doc-grid" [class.collapsed]="isSectionCollapsed('application', 'documentation')">
                @for (doc of applicationStatus.documentation; track doc.name) {
                  <div class="doc-item" (click)="openDocument(doc)">
                    <div class="doc-info">
                      <h4>{{ doc.name }}</h4>
                    </div>
                  </div>
                }
              </div>
            </div>
          }

          @if (applicationStatus.valid) {
            <div class="tools-section">
              <h3 class="collapsible-header" (click)="toggleSection('application', 'tools')">
                <mat-icon class="collapse-icon" [class.collapsed]="isSectionCollapsed('application', 'tools')">
                  expand_more
                </mat-icon>
                Tools
              </h3>
              <div class="tools-grid" [class.collapsed]="isSectionCollapsed('application', 'tools')">
                @for (tool of applicationStatus.tools; track tool.name) {
                  <div class="tool-item"  (click)="onToolClick(null, tool)">
                    <div class="tool-header">
                      <div class="tool-info">
                        <h4 style="color: white;">{{ tool.name }}</h4>
                        @if (tool.version) {
                          <div class="tool-meta">
                            <span class="version" style="color: white;">v{{ tool.version }}</span>
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
          }
        </div>
      </mat-tab>

      <!-- Project Tabs -->
      @for (project of applicationStatus.projects; track project.name) {
        <mat-tab>
          <ng-template mat-tab-label>
            <span>📦</span>
            {{ project.name }}
            @if (hasMissingAssets(project)) {
              <mat-icon class="missing-assets-tab-icon" matTooltip="This project has missing assets">warning</mat-icon>
            }
          </ng-template>
        
        <div class="tab-content">
          <!-- Project Overview -->
          <div class="project-overview">
            <div class="project-info">
              <div class="project-title-row">
                <h3>Project: {{ project.name }}</h3>
                <div class="intellisense-checkbox-row">
                  <label class="intellisense-checkbox-label">
                    <input type="checkbox"
                      [checked]="intellisenseProject === project.name"
                      (change)="onIntellisenseProjectChange(project.name)"
                    />
                    <span>Intellisense Project</span>
                  </label>
            <mat-icon
              matTooltip="In ModusToolbox, VS Code intellisense works best when the CLANGD backend is used and intellisense is focused on one of the many projects that make up a ModusToolbox application.  Checking this box makes this project the focus of intellisense."
              class="intellisense-help-icon"
              style="vertical-align: middle; cursor: pointer; margin-left: 4px;"
            >help_outline</mat-icon>
                </div>
              </div>
              <!-- Project details (version, type, status, last build) removed as requested -->
              
              <!-- Project Build Actions -->
              <div class="project-build-actions">
                <button mat-raised-button class="project-build-btn build-btn" (click)="buildProject(project)" [disabled]="running">
                  <mat-icon>build</mat-icon>
                  Build
                </button>
                <button mat-raised-button class="project-build-btn rebuild-btn" (click)="rebuildProject(project)" [disabled]="running">
                  <mat-icon>refresh</mat-icon>
                  Rebuild
                </button>
                <button mat-raised-button class="project-build-btn clean-btn" (click)="cleanProject(project)" [disabled]="running">
                  <mat-icon>cleaning_services</mat-icon>
                  Clean
                </button>
                <button mat-raised-button class="project-build-btn program-btn" 
                        (click)="programProject(project)" 
                        [disabled]="running">
                  <mat-icon>download</mat-icon>
                  Program
                </button>
              </div>
              
              <!-- Missing Assets Indicator -->
              @if (hasMissingAssets(project)) {
                <div class="missing-assets-indicator">
                  <div class="warning-badge">
                    <mat-icon class="warning-icon">warning</mat-icon>
                    <span class="warning-text">Missing Assets</span>
                  </div>
                  <div class="missing-actions">
                    <button 
                      class="fix-assets-button" 
                      [disabled]="isFixingAssets(project)"
                      (click)="fixMissingAssets(project)">
                      @if (isFixingAssets(project)) {
                        <mat-icon>hourglass_empty</mat-icon>
                        Running...
                      } @else {
                        <mat-icon>build</mat-icon>
                        Fix Missing Assets
                      }
                    </button>
                    @if (isFixingAssets(project) && getCurrentlyLoadingAsset(project)) {
                      <div class="loading-asset-indicator">
                        <div class="loading-spinner"></div>
                        <span class="loading-text">Loaded: {{ getCurrentlyLoadingAsset(project) }}</span>
                      </div>
                    }
                  </div>
                </div>
              }

                <!-- Components Section (Collapsible) -->
                <div class="components-section">
                  <h3 class="collapsible-header" (click)="toggleSection(project.name, 'components')">
                    <mat-icon class="collapse-icon" [class.collapsed]="isSectionCollapsed(project.name, 'components')">
                      expand_more
                    </mat-icon>
                    Enabled Components
                    <mat-icon matTooltip="Components are a feature of the ModusToolbox middleware that enables specific features of a given middleware library." style="vertical-align: middle; cursor: help; margin-left: 0.5em;" color="primary">help_outline</mat-icon>
                  </h3>
                  <div class="enabled-components-tags" [class.collapsed]="isSectionCollapsed(project.name, 'components')">
                    @if (project.components && project.components.length > 0) {
                      @for (component of project.components; track component.name) {
                        <span class="component-tag" [title]="component.description || 'No Description Found'">
                          <mat-icon class="component-icon">extension</mat-icon>
                          <span class="component-name">{{ component.name }}</span>
                        </span>
                      }
                    } @else {
                      <span class="no-enabled-components">No enabled components found.</span>
                    }
                  </div>
                </div>
            </div>
          </div>

          <!-- Project Documentation -->
          <div class="documentation-section">
            <h3 class="collapsible-header" (click)="toggleSection(project.name, 'documentation')">
              <mat-icon class="collapse-icon" [class.collapsed]="isSectionCollapsed(project.name, 'documentation')">
                expand_more
              </mat-icon>
              Project Documentation
            </h3>
            <div class="doc-grid" [class.collapsed]="isSectionCollapsed(project.name, 'documentation')">
              @for (doc of project.documentation; track doc.name) {
                <div class="doc-item" (click)="openDocument(doc)">
                  <div class="doc-info">
                    <h4>{{ doc.name }}</h4>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Project Middleware -->
          <div class="middleware-section">
            <h3 class="collapsible-header" (click)="toggleSection(project.name, 'middleware')">
              <mat-icon class="collapse-icon" [class.collapsed]="isSectionCollapsed(project.name, 'middleware')">
                expand_more
              </mat-icon>
              Project Middleware
            </h3>
            <div class="middleware-grid" [class.collapsed]="isSectionCollapsed(project.name, 'middleware')">
              @for (middleware of project.middleware; track middleware.name) {
                <div class="middleware-item" [class.missing-middleware]="isMiddlewareMissing(project, middleware.name)" (click)="onMiddlewareClick(project, middleware)">
                  <div class="middleware-header">
                    <div class="middleware-info">
                      <h4>{{ middleware.name }}</h4>
                      <span class="version">{{ middleware.version }}</span>
                      @if (middleware.newer) {
                        <div class="newer-version-indicator">
                          <mat-icon class="newer-icon">update</mat-icon>
                          <span class="newer-text">Update Available</span>
                        </div>
                      }
                      @if (isMiddlewareMissing(project, middleware.name)) {
                        <div class="missing-indicator">
                          <mat-icon class="missing-icon">warning</mat-icon>
                          <span class="missing-text">Missing</span>
                        </div>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Project Tools -->
          <div class="tools-section">
            <h3 class="collapsible-header" (click)="toggleSection(project.name, 'tools')">
              <mat-icon class="collapse-icon" [class.collapsed]="isSectionCollapsed(project.name, 'tools')">
                expand_more
              </mat-icon>
              Tools
            </h3>
            <div class="tools-grid" [class.collapsed]="isSectionCollapsed(project.name, 'tools')">
              @for (tool of project.tools; track tool.name) {
                <div class="tool-item" (click)="onToolClick(project, tool)">
                  <div class="tool-header">
                    <div class="tool-info">
                      <div class="tool-name">
                        <h4 style="color: white;">{{ tool.name }}</h4>
                      </div>
                      <div class="tool-meta">
                        <span class="version" style="color: white;">v{{ tool.version }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </mat-tab>
      }
    </mat-tab-group>
    </div>
  }
  @else {
    <div class="no-status">
      <mat-icon>info</mat-icon>
      <p>Loading Application</p>
    </div>
  }

  <!-- LLVM Installer Overlay -->
  @if (displayLLVMInstallControl) {
    <app-llvm-installer (close)="closeLLVMInstaller()"></app-llvm-installer>
  }
</div>
