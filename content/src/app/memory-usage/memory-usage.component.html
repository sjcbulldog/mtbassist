<div class="memory-usage-section">
  <div class="memory-usage-card">
    <div class="memory-header-container" style="display: flex; align-items: center;">
      <h3 class="collapsible-header" (click)="toggleMainSection()" style="flex: 1; margin: 0;">
        <mat-icon class="collapse-icon" [class.collapsed]="isMainSectionCollapsed">expand_more</mat-icon>
        Memory Usage
      </h3>
      <button 
        mat-icon-button 
        (click)="expandAll()" 
        matTooltip="Expand all sections"
        style="margin-left: 8px;">
        <mat-icon>unfold_more</mat-icon>
      </button>
      <button 
        mat-icon-button 
        (click)="collapseAll()" 
        matTooltip="Collapse all sections"
        style="margin-left: 4px;">
        <mat-icon>unfold_less</mat-icon>
      </button>
      <mat-icon
        matTooltip="This shows the combined memory usage across all of the projects using the latest build. This means if a latest build was a DEBUG build that will be used. This is per project so there can be a mix of DEBUG and RELEASE builds depending on what was built last."
        class="memory-help-icon"
        style="cursor: pointer; margin-left: 8px;"
        (click)="$event.stopPropagation()"
      >help_outline</mat-icon>
    </div>
    <div class="memory-usage-container" [class.collapsed]="isMainSectionCollapsed">
      <table class="memory-table">
        <thead>
          <tr>
            <th>Memory Name</th>
            <th>Start Address</th>
            <th>Size</th>
            <th>Percent Used</th>
          </tr>
        </thead>
        <tbody>
          @for (memory of memoryUsageData; track memory.name) {
            <tr class="memory-row" (click)="toggleMemorySection(memory.name)">
              <td class="memory-name">
                <mat-icon class="expand-icon" [class.collapsed]="isMemorySectionCollapsed(memory.name)">expand_more</mat-icon>
                {{ memory.name }}
              </td>
              <td>-</td>
              <td>{{ formatHex(memory.size) }}</td>
              <td>
                {{ memory.percent.toFixed(2) }}% 
                <mat-icon 
                  class="inline-info-icon"
                  matTooltip="Percentage of total physical memory used by this memory section"
                  style="font-size: 16px; width: 16px; height: 16px; vertical-align: middle; margin-left: 4px; cursor: help;">
                  devices
                </mat-icon>
              </td>
            </tr>
            @if (!isMemorySectionCollapsed(memory.name)) {
              @for (region of memory.regions; track region.name) {
                <tr class="region-row" (click)="toggleRegionCollapse(memory.name, region.name)">
                  <td class="region-name">
                    <span class="region-indent">└─ </span>
                    <mat-icon class="expand-icon" [class.collapsed]="isRegionCollapsed(memory.name, region.name)">expand_more</mat-icon>
                    {{ region.name }}
                  </td>
                  <td>{{ formatHex(region.offset) }}</td>
                  <td>{{ formatHex(region.size) }}</td>
                  <td>
                    {{ region.percent.toFixed(2) }}% 
                    <mat-icon 
                      class="inline-info-icon"
                      matTooltip="Percentage of this user-defined region's memory that is used"
                      style="font-size: 16px; width: 16px; height: 16px; vertical-align: middle; margin-left: 4px; cursor: help;">
                      person
                    </mat-icon>
                  </td>
                </tr>
                @if (!isRegionCollapsed(memory.name, region.name)) {
                  @for (segment of region.segments; track segment.start) {
                    <tr class="segment-row">
                      <td class="segment-name">
                        <span class="segment-indent">   └─ </span>
                        @if(segment.type === 'virtual') {
                          <span class="segment-type" [class.virtual]="true" matTooltip="This memory segment is virtual memory, generally in RAM and copied from a non-volatile memory at startup.">Virtual</span>
                        } @else if(segment.type === 'physical') {
                          <span class="segment-type" [class.physical]="true" matTooltip="This memory segment is physical memory, generally in non-volatile memory but to be copied into another memory.">Physical</span>
                        } @else if(segment.type === 'virtual/physical') {
                          <span class="segment-type" [class.virtual-physical]="true" matTooltip="This memory segment is both virtual and physical, generally in non-volatile memory and accessed directly from that memory.">Both</span>
                        } @else if(segment.type === 'unused') {
                          <span class="segment-type" [class.unused]="true" matTooltip="This memory segment is currently unused.">Unused</span>
                        }
                      </td>
                      <td>{{ formatHex(segment.start) }}</td>
                      <td>{{ formatHex(segment.msize) }}</td>
                      <td>-</td>
                    </tr>
                  }
                }
              }
            }
          }
        </tbody>
      </table>
    </div>
  </div>
</div>
