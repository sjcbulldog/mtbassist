<div class="memory-usage-section">
  <div class="memory-usage-card">
    <div class="memory-header-container" style="display: flex; align-items: center;">
      <h3 class="collapsible-header" (click)="toggleMainSection()" style="flex: 1; margin: 0;">
        <mat-icon class="collapse-icon" [class.collapsed]="isMainSectionCollapsed">expand_more</mat-icon>
        Memory Usage
      </h3>
      <mat-icon
        matTooltip="This shows the combined memory usage across all of the projects using the latest build. This means if a latest build was a DEBUG build that will be used. This is per project so there can be a mix of DEBUG and RELEASE builds depending on what was built last."
        class="memory-help-icon"
        style="cursor: pointer; margin-left: 8px;"
        (click)="$event.stopPropagation()"
      >help_outline</mat-icon>
    </div>
    <div class="memory-usage-container" [class.collapsed]="isMainSectionCollapsed">
      <table class="memory-table">
        <thead>
          <tr>
            <th>Memory Name</th>
            <th>Start Address</th>
            <th>Size</th>
            <th>Percent Used</th>
          </tr>
        </thead>
        <tbody>
          @for (memory of memoryUsageData; track memory.name) {
            <tr class="memory-row" (click)="toggleMemorySection(memory.name)">
              <td class="memory-name">
                <mat-icon class="expand-icon" [class.collapsed]="isMemorySectionCollapsed(memory.name)">expand_more</mat-icon>
                {{ memory.name }}
              </td>
              <td>{{ formatHex(memory.start) }}</td>
              <td>{{ formatHex(memory.size) }}</td>
              <td>{{ memory.percent.toFixed(1) }}%</td>
            </tr>
            @if (!isMemorySectionCollapsed(memory.name)) {
              @for (segment of memory.segments; track segment.start) {
                <tr class="segment-row">
                  <td class="segment-name">
                    <span class="segment-indent">└─ </span>
                      @if(segment.type === 'virtual') {
                        <span class="segment-type" [class.virtual]="true" matTooltip="This memory segment is virtual memory, generally in RAM an copied from a non-volatile memory at startup.">Virtual</span>
                      } @else if(segment.type === 'physical') {
                        <span class="segment-type" [class.physical]="true" matTooltip="This memory segment is physical memory, generally in non-volatile memory but to be copied into another memory.">Physical</span>
                      } @else if(segment.type === 'virtual/physical') {
                        <span class="segment-type" [class.virtual-physical]="true" matTooltip="This memory segment is both virtual and physical, generally in non-volatile memory and access directly from that memory.">Both</span>
                      } @else if(segment.type === 'unused') {
                        <span class="segment-type" [class.unused]="true" matTooltip="This memory segment is currently unused.">Unused</span>
                      }
                  </td>
                  <td>{{ formatHex(segment.start) }}</td>
                  <td>{{ formatHex(segment.size) }}</td>
                  <td>
                    @if (shouldCollapseSections(segment.sections)) {
                      <div class="sections-container">
                        <div class="sections-toggle" (click)="toggleSectionsCollapse(memory.name, segment.start)">
                          <mat-icon class="expand-icon" [class.collapsed]="isSectionsCollapsed(memory.name, segment.start)">expand_more</mat-icon>
                          @if (isSectionsCollapsed(memory.name, segment.start)) {
                            <span class="sections-count">{{ segment.sections.length }} sections</span>
                          } @else {
                            <span class="sections-count">{{ segment.sections.length }} sections (expanded)</span>
                          }
                        </div>
                        @if (!isSectionsCollapsed(memory.name, segment.start)) {
                          <div class="sections-list expanded">
                            @for (section of segment.sections; track section) {
                              <span class="section-tag">{{ section }}</span>
                            }
                          </div>
                        }
                      </div>
                    } @else {
                      <div class="sections-list">
                        @for (section of segment.sections; track section) {
                          <span class="section-tag">{{ section }}</span>
                        }
                      </div>
                    }
                  </td>
                </tr>
              }
            }
          }
        </tbody>
      </table>
    </div>
  </div>
</div>
