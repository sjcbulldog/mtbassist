<div class="local-content-storage-container" [class.dark-theme]="themeType === 'dark'" [class.light-theme]="themeType === 'light'">
  
  <!-- Busy Overlay -->
  @if (busy) {
    <div class="busy-overlay">
      <div class="busy-content">
        <span class="busy-message">Updating Local Content Storage ...</span>
        <span class="busy-message">This takes a while ...</span>        
        <span class="busy-message">Do not close VS Code until this is complete.</span>
        <mat-spinner diameter="50"></mat-spinner>
      </div>
    </div>
  }

  <div class="header">
    <h2>Local Content Storage Management</h2>
  </div>

  <div class="lists-container">
    <!-- Not In Local Storage List -->
    <div class="list-section">
      <mat-card class="list-card">
        <mat-card-header>
          <mat-card-title class="list-title">Not Available Locally</mat-card-title>
        </mat-card-header>
        
        <!-- Filter Input for Left List -->
        <div class="filter-section">
          <mat-form-field appearance="outline" class="filter-input">
            <mat-label>Filter BSPs</mat-label>
            <input 
              matInput 
              [(ngModel)]="leftListFilterText" 
              placeholder="Type to filter..."
              [disabled]="busy || showChanges">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>
        
        <mat-card-content>
          <div 
            class="bsp-list"
            cdkDropList
            #notInList="cdkDropList"
            [cdkDropListData]="bspsNotInList"
            [cdkDropListConnectedTo]="[inList]"
            [cdkDropListDisabled]="busy"
            (cdkDropListDropped)="onDrop($event)">
            @for (bsp of displayedBspsNotIn; track bsp) {
              <div [class]="getBspClasses(bsp, false)" cdkDrag [cdkDragData]="bsp" [cdkDragDisabled]="busy">
                <mat-icon cdkDragHandle class="drag-handle">drag_indicator</mat-icon>
                <span class="bsp-name">{{ bsp }}</span>
                @if (isInAddQueue(bsp)) {
                  <mat-icon class="status-icon pending-add-icon" matTooltip="Queued for addition">add_circle</mat-icon>
                }
              </div>
            }
            @if (displayedBspsNotIn.length === 0 && bspsNotInList.length === 0) {
              <div class="empty-list">Loading manifest data...</div>
            }
            @if (displayedBspsNotIn.length === 0 && bspsNotInList.length > 0 && showChanges) {
              <div class="empty-list">No BSPs to be removed</div>
            }
            @if (displayedBspsNotIn.length === 0 && bspsNotInList.length > 0 && !showChanges) {
              <div class="empty-list">All BSPs are stored locally</div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Add/Remove All Buttons -->
    <div class="arrow-buttons-section">
      <button 
        mat-raised-button 
        color="primary"
        class="arrow-button"
        [disabled]="busy"
        matTooltip="Move all BSPs to local storage"
        (click)="moveToLocalStorage()">
        Add All
      </button>
      <button 
        mat-raised-button 
        color="accent"
        class="arrow-button"
        [disabled]="busy"
        matTooltip="Remove all BSPs from local storage"
        (click)="removeFromLocalStorage()">
        Remove All
      </button>
      <button 
        mat-raised-button 
        color="warn"
        class="arrow-button"
        [disabled]="busy"
        matTooltip="Revert all pending changes"
        (click)="onRevert()">
        Revert
      </button>
    </div>

    <!-- In Local Storage List -->
    <div class="list-section">
      <mat-card class="list-card">
        <mat-card-header>
          <mat-card-title class="list-title">Available Locally</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div 
            class="bsp-list"
            cdkDropList
            #inList="cdkDropList"
            [cdkDropListData]="bspsInList"
            [cdkDropListConnectedTo]="[notInList]"
            [cdkDropListDisabled]="busy"
            (cdkDropListDropped)="onDrop($event)">
            @for (bsp of displayedBspsIn; track bsp) {
              <div [class]="getBspClasses(bsp, true)" cdkDrag [cdkDragData]="bsp" [cdkDragDisabled]="busy">
                <mat-icon cdkDragHandle class="drag-handle">drag_indicator</mat-icon>
                <span class="bsp-name">{{ bsp }}</span>
                @if (isInDeleteQueue(bsp)) {
                  <mat-icon class="status-icon pending-delete-icon" matTooltip="Queued for removal">remove_circle</mat-icon>
                }
              </div>
            }
            @if (displayedBspsIn.length === 0 && bspsInList.length === 0) {
              <div class="empty-list">No items stored locally</div>
            }
            @if (displayedBspsIn.length === 0 && bspsInList.length > 0 && showChanges) {
              <div class="empty-list">No BSPs to be added</div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- BSP Changes Card -->
  @if (needsApply) {
    <mat-card class="bsp-update-card">
      <mat-card-content>
        <div class="bsp-update-content">
            <div class="bsp-update-message">
                <mat-icon class="warning-icon">warning</mat-icon>
                <span class="update-text">The local content storage configuration has changed. Press apply to update the local content storage</span>
            </div>
            <div class="bsp-update-controls">
              <mat-checkbox 
                [checked]="showChanges"
                (change)="onShowChangesChange($event.checked)"
                color="primary"
                [disabled]="busy">
                Show Changes
              </mat-checkbox>
              <button 
                mat-raised-button 
                color="warn"
                (click)="applyBspChanges()"
                class="apply-button"
                [disabled]="busy">
                <mat-icon>check</mat-icon>
                Apply
              </button>
            </div>
        </div>
      </mat-card-content>
    </mat-card>
  }

  <!-- Update Controls -->
  <div class="update-controls">
    <div class="update-status">
      @if (needsUpdate) {
        <mat-icon class="update-icon available">cloud_download</mat-icon>
        <span class="status-text available">Updates Available</span>
      } @else {
        <mat-icon class="update-icon current">check_circle</mat-icon>
        <span class="status-text current">Up to Date</span>
      }
    </div>
          
    <button 
        mat-raised-button 
        color="accent" 
        [disabled]="!needsUpdate || busy"
        (click)="startUpdate()"
        class="update-button">
        <mat-icon>download</mat-icon>
        Start Update
    </button>

    <div class="update-buttons">
      <button 
        mat-raised-button 
        color="primary" 
        (click)="checkForUpdates()"
        class="update-button"
        [disabled]="busy">
        <mat-icon>refresh</mat-icon>
        Check for Updates
      </button>

    </div>
  </div>
</div>
